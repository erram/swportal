<!doctype html>
<html>
<head>
    <script src="../jquery/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.12/css/dataTables.bootstrap.min.css" rel="stylesheet"/>
    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
    
    <style>
        body         { padding-top:80px; word-wrap:break-word; }
        #user-role {
            display: none;
        }
        .modal-box {display:none}
    </style>
</head>
<body>
<div class="container">
    <div class="page-header text-center">
        <h1><span class="fa fa-anchor"></span> User lista</h1>
        <a href="/logout" class="btn btn-default btn-sm">Logout</a>
    </div>
    
    <div class="row">
<table class="table" id="example">
  <thead class="thead-inverse">
    <tr>
      <th>Email</th>
      <th>Username</th>
      <th>Role</th>
    </tr>
  </thead>
  <tbody>
    <div class="modal-box alert alert-success"></div>
    <% for(var i=0; i < users.length; i++) { %>
    <tr>
        <td class="userEmail"><%= users[i].local.email %></td>
        <td><%= users[i].local.username %></td>
        <td>
            <select class="form-control user-select">
                <option>User</option>
                <option>Admin</option>
                <option>Newswriter</option>
            </select>
            <span id="user-role"><%= users[i].local.role %></span>
        </td>    
    </tr>
    <% } %>    
  </tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.12/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.12/js/dataTables.bootstrap.min.js"></script>
        <script>
        $(document).ready(function() {
             function statechange(){
                    var userRoleLista = $(".user-select");
                    userRoleLista.each(function(){
                        var state = $(this).next().text();
                        var options = $(this).find('option')
                        options.each(function(){
                            if($(this).text() == state) {
                                $(this).attr('selected',"selected")
                            }
                        })
                    })
            };
            $('#example').DataTable();
            var table = $('#example').DataTable(); 
            table.on( 'draw', function () {
                statechange();
                update();
            } );
            statechange();

            function update() {
                $('.user-select').change(function(){
                    var state = $(this).find('option:selected').html();
                    var user = $(this).closest('tr').find('.userEmail').html()
                    console.log(state)
                    $.ajax
                    ({ 
                        url: 'user/updatestatus',
                        data: {"status":state, "userEmail":user},
                        type: 'post',
                        success: function(data)
                        {
                            $('.modal-box').text("Hír státusa módosítva " +data).fadeIn(700, function() 
                            {
                                setTimeout(function() 
                                {
                                    $('.modal-box').fadeOut();
                                }, 2000);
                            });
                        }
                    });
                });  
            }

            update();

         
        });
        </script>
    </div>
</div>
</body>
</html>
