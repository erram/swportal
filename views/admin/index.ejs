<!doctype html>
<html>
<head>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css">
    <link rel="stylesheet" href="style/app.css">
    <script src="../jquery/dist/jquery.min.js"></script>
    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
</head>
<style>
        #publish {
            display: none;
        }
        #user-role {
            display: none;
        }
        .modal-box {display:none}
        .modal-box2 {display:none}
</style>

<body>
<%- include('../header') %>
    <div id="main-content" class="container">
        <div class="article-container">
            <div class="jumbotron">
                <h1><strong><i class="fa fa-file-text-o" aria-hidden="true"></i>&nbsp Hír lista</strong></h1>
                <hr class="my-4">
                <table class="table" id="example">
                <thead class="thead-inverse">
                    <tr>
                    <th>Postolta</th>
                    <th>Cím</th>
                    <th>Dátum</th>
                    <th style="text-align:center">Státusz</th>
                    </tr>
                </thead>
                <tbody>
                    <div class="modal-box alert alert-success"></div>
                    <% for(var i=0; i < news.length; i++) { %>
                    <tr>
                        <td><%= usr %></td>
                        <td><a href="/news/item/<%= news[i].ID; %>"><span><%= news[i].Cím %></span></a></td>
                        <td><%=  moment(news[i].Dátum).format('MMM-DD-YYYY') %></td>  
                        <td align="center">
                        <input id="<%= news[i].ID %>" class="togglef" type="checkbox" checked data-toggle="toggle" data-on="Publikálva" data-off="Nem publikálva" data-onstyle="success" data-offstyle="danger">
                        <span id="publish"><%= news[i].Publikálva %></span>
                        </td>   
                    </tr>
                    <% } %>    
                </tbody>
                </table>
            </div>
             
            <div class="jumbotron">
                <h1><strong><i class="fa fa-file-text-o" aria-hidden="true"></i>&nbsp User lista</strong></h1>
                <hr class="my-4">
                <table class="table" id="example2">
                <thead class="thead-inverse">
                    <tr>
                    <th>Email</th>
                    <th>Username</th>
                    <th>Role</th>
                    </tr>
                </thead>
                <tbody>
                    <div class="modal-box2 alert alert-success"></div>
                    <% for(var i=0; i < users.length; i++) { %>
                    <tr>
                        <td class="userEmail"><%= users[i].local.email %></td>
                        <td><%= users[i].local.username %></td>
                        <td>
                            <select class="form-control user-select">
                                <option>User</option>
                                <option>Admin</option>
                                <option>Newswriter</option>
                            </select>
                            <span id="user-role"><%= users[i].local.role %></span>
                        </td>    
                    </tr>
                    <% } %>    
                </tbody>
                </table>
            </div>
        </div>
    </div>

    <%- include('../footer') %>
<script src="js/app-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.12/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.12/js/dataTables.bootstrap.min.js"></script>
        <script>
        $(document).ready(function() {
             function statechange(){
                    var togglelista = $(".togglef");
                    togglelista.each(function(){
                    var state = $(this).parent().next().text();
                    if(state == 'false') {
                        $(this).bootstrapToggle('off');
                    } else {
                        $(this).bootstrapToggle('on');
                    }
                })
            };
            $('#example').DataTable();
            var table = $('#example').DataTable(); 
            table.on( 'draw', function () {
                statechange();
                 update();
            } );
            statechange();

            function update() {
                $('.toggle').click(function(){
                    var news_id = $(this).children('input').attr('id');
                    var status = $(this).next('span').html();

                    if(status == "true") {
                        $(this).next('span').html("false");
                        status = "false";
                    } else if(status == "false") {
                        $(this).next('span').html("true");
                        status = "true";
                    }
                    
                    $.ajax
                    ({ 
                        url: '/admin/news/updatestatus',
                        data: {"newsID": news_id,"status":status},
                        type: 'post',
                        success: function(data)
                        {
                            $('.modal-box').text("Hír státusa módosítva " +data).fadeIn(700, function() 
                            {
                                setTimeout(function() 
                                {
                                    $('.modal-box').fadeOut();
                                }, 2000);
                            });
                        }
                    });
                });  
            }

            update();

             function statechange2(){
                    var userRoleLista = $(".user-select");
                    userRoleLista.each(function(){
                        var state = $(this).next().text();
                        var options = $(this).find('option')
                        options.each(function(){
                            if($(this).text() == state) {
                                $(this).attr('selected',"selected")
                            }
                        })
                    })
            };
            $('#example2').DataTable();
            var table = $('#example2').DataTable(); 
            table.on( 'draw', function () {
                statechange2();
                update2();
            } );
            statechange2();

            function update2() {
                $('.user-select').change(function(){
                    var state = $(this).find('option:selected').html();
                    var user = $(this).closest('tr').find('.userEmail').html()
                    $.ajax
                    ({ 
                        url: 'admin/user/updatestatus',
                        data: {"status":state, "userEmail":user},
                        type: 'post',
                        success: function(data)
                        {
                            $('.modal-box2').text("User státusa módosítva " +data).fadeIn(700, function() 
                            {
                                setTimeout(function() 
                                {
                                    $('.modal-box2').fadeOut();
                                }, 2000);
                            });
                        }
                    });
                });  
            }

            update2();

         
        });
        </script>
</body>
</html>
